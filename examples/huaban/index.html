<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>花瓣图片 瀑布流 免登陆</title>
	<!-- CDN -->
	<link href="https://cdn.bootcss.com/normalize/8.0.0/normalize.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://cdn.bootcss.com/vue/2.5.16/vue.min.js"></script>
	<script src="https://cdn.bootcss.com/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script>
	<script src="https://cdn.bootcss.com/masonry/4.2.1/masonry.pkgd.min.js"></script>
	<script src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
	<script src="https://cdn.bootcss.com/urljs/2.3.1/url.min.js"></script>
	<!-- 自定义 -->
	<link rel="stylesheet" type="text/css" href="css/demo.css" />
</head>

<body class="loading">
	<main id="app">
		<header class="codrops-header">
			<div class="codrops-header__title">
				<input v-model="query" type="text" placeholder="搜索你喜欢的" value="">
				<button @click="search()">查询</button>
			</div>
		</header>
		<div class="content content--side">
			<div class="control control--grids">
				<span class="control__title">switch layout</span>
				<div class="control__item">
					<input class="control__radio" type="radio" name="grid-type" value="grid--type-a" id="control-grid-a" checked>
					<label class="control__label" for="control-grid-a">grid A</label>
				</div>
				<div class="control__item" style="display:none;">
					<input class="control__radio" type="radio" name="grid-type" value="grid--type-b" id="control-grid-b">
					<label class="control__label" for="control-grid-b">grid B</label>
				</div>
				<div class="control__item" style="display:none;">
					<input class="control__radio" type="radio" name="grid-type" value="grid--type-c" id="control-grid-c">
					<label class="control__label" for="control-grid-c">grid C</label>
				</div>
			</div>
		</div>
		<div class="content content--side content--right">
			<div class="control control--effects">
				<span class="control__title">run effect</span>
				<button class="control__btn" data-fx="Hapi">Hapi</button>
				<button class="control__btn" data-fx="Amun">Amun</button>
				<button class="control__btn" data-fx="Kek">Kek</button>
				<button class="control__btn" data-fx="Isis">Isis</button>
				<button class="control__btn" data-fx="Montu">Montu</button>
				<button class="control__btn" data-fx="Osiris">Osiris</button>
				<button class="control__btn" data-fx="Satet">Satet</button>
				<button class="control__btn" data-fx="Atum">Atum</button>
				<button class="control__btn" data-fx="Ra">Ra</button>
				<button class="control__btn" data-fx="Sobek">Sobek</button>
				<button class="control__btn" data-fx="Ptah">Ptah</button>
				<button class="control__btn" data-fx="Bes">Bes</button>
				<button class="control__btn" data-fx="Seker">Seker</button>
				<button class="control__btn" data-fx="Nut">Nut</button>
				<button class="control__btn" data-fx="Shu">Shu</button>
			</div>
		</div>
		<div class="content content--center">
			<div class="grid grid--type-a">
				<div class="grid__sizer"></div>
				<div v-for="item,key in pins" :key="key" class="grid__item">
					<a :href="item" class="grid__link" target="_blank">
						<img class="grid__img" :src="item+'_fw236'" onerror="javascript:$(this).remove();" />
					</a>
				</div>
			</div>
		</div>
	</main>
	<div style="text-align:center;margin:50px 0; font:normal 14px/24px 'MicroSoft YaHei';">
		<p>适用浏览器：360、FireFox、Chrome、Opera、傲游、搜狗、世界之窗. 不支持Safari、IE8及以下浏览器。</p>
	</div>

	<script type="text/javascript">
		// 代理ajax
		function proxyAjax(option,callback) { 
			$.ajax({
				url:"http://127.0.0.1:8000/api/xhr",
				type:'POST',
				data:JSON.stringify(option),
				dataType:"json",
				success:function(result,textStatus,jqXHR){
					if(result.status){
						typeof callback=="function" ? callback(result.data) : null;
					}else{
						console.error("接口访问失败",result.msg);
					}
				}
			});
		}
		var v$app = new Vue({
			el: "#app",
			data: {
				query: "帅", page: 1, size: 20,
				pins: []
			},
			mounted: function () {
				//首次渲染完成
				_this = this;
				_this.$nextTick(function () {
					_this.getPins();
				});
				//还可以基window窗口（body）来添加滚动事件, (因为布局不同,所以在这里没效果，因为[上面是基于body中的某个元素来添加滚动事的])
				$(window).scroll(function () {
					//当时滚动条离底部60px时开始加载下一页的内容
					if (($(window).height() + $(window).scrollTop() + 60) >= $(document).height()) {
						window.timers ? clearTimeout(window.timers) : null;
						timers = setTimeout(function () {
							_this.page = _this.page + 1;
							_this.getPins();
							console.log("第" + _this.page + "页");
						}, 300);
					}
				});
			},
			methods: {
				search() {
					this.page = 1; this.pins = [];
					_this.$nextTick(function () {
						_this.getPins();
					});
				},
				renderPins(re) {
					$(re).find("body").prevObject.map(function (i, e) {
						return e.nodeName == "SCRIPT" && !e.src && e.innerText.indexOf('app.page["pins"]') >= 0 ? e : null;
					}).each(function (i, e) {
						var pinsList = $(e).text().match(/"key"\s*:\s*"[^"]*"/gm).join(",").replace(/("key":|")/gm, "").split(",");
						pinsList.map(function (e, i) {
							_this.pins.push("http://img.hb.aicdn.com/" + e);
						});
						// 展示动画特效插件
						_this.$nextTick(function () {
							$(document.body).append($("<script>").attr("src","js/main.js"))
						});
					});
				},
				getPins() {
					_this = this;
					var querystring = Url.stringify({ q: encodeURI(_this.query), page: _this.page, per_page: _this.size });//, category: "beauty"
					var option = {
						url: /^http/g.test(_this.query) ? _this.query : ["http://huaban.com/search/", querystring].join("?"),
						method: "GET"
					};
					proxyAjax(option, _this.renderPins);
				}
			}
		});
	</script>
</body>

</html>